"use strict";!function e(t,o,s){function i(n,c){if(!o[n]){if(!t[n]){var d="function"==typeof require&&require;if(!c&&d)return d(n,!0);if(r)return r(n,!0);var a=new Error("Cannot find module '"+n+"'");throw a.code="MODULE_NOT_FOUND",a}var l=o[n]={exports:{}};t[n][0].call(l.exports,function(e){var o=t[n][1][e];return i(o?o:e)},l,l.exports,e,t,o,s)}return o[n].exports}for(var r="function"==typeof require&&require,n=0;n<s.length;n++)i(s[n]);return i}({1:[function(e,t,o){var s=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},i=SupEngine.THREE,r=e("./CubicModelRendererUpdater"),n=function(e){function t(t){e.call(this,t,"ModelRenderer"),this.materialType="basic"}return s(t,e),t.prototype._clearMesh=function(){this.actor.threeObject.remove(this.threeRoot),this.threeRoot.traverse(function(e){null!=e.dispose&&e.dispose()}),this.threeRoot=null,this.byNodeId=null},t.prototype._destroy=function(){null!=this.asset&&this._clearMesh(),this.asset=null,e.prototype._destroy.call(this)},t.prototype.setCubicModel=function(e,t,o){var s=this;if(null!=this.asset&&this._clearMesh(),this.asset=e,null!=e){this.threeRoot=new i.Object3D,this.threeRoot.scale.set(1/e.pixelsPerUnit,1/e.pixelsPerUnit,1/e.pixelsPerUnit),this.byNodeId={};for(var r=function e(t,o,i){for(var r=s._makeNode(t,o,i),n=0,c=t.children;n<c.length;n++){var d=c[n];e(d,r,t.shape.offset)}},n=0,c=e.nodes;n<c.length;n++){var d=c[n];r(d,null,{x:0,y:0,z:0})}this.actor.threeObject.add(this.threeRoot),this.threeRoot.updateMatrixWorld(!1)}},t.prototype._makeNode=function(e,t,o){var s,r=new i.MeshBasicMaterial({map:this.asset.textures.map,side:i.DoubleSide,transparent:!0});s=new i.Object3D,s.name=e.name,s.userData.cubicNodeId=e.id;var n;if("box"===e.shape.type){var c=e.shape.settings.size,d=new i.BoxGeometry(c.x,c.y,c.z);this.updateBoxNodeUv(d,e),n=new i.Mesh(d,r),n.scale.set(e.shape.settings.stretch.x,e.shape.settings.stretch.y,e.shape.settings.stretch.z)}null!=n&&(n.position.set(e.shape.offset.x,e.shape.offset.y,e.shape.offset.z),s.add(n));var a={pivot:s,shape:n,nodeId:e.id,children:[]};return this.byNodeId[e.id]=a,null!=t&&t.children.push(a),s.position.set(e.position.x+o.x,e.position.y+o.y,e.position.z+o.z),s.quaternion.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),null==t?this.threeRoot.add(s):t.pivot.add(s),s.updateMatrixWorld(!1),a},t.prototype.updateBoxNodeUv=function(e,t){var o,s=this.asset.textureWidth,r=this.asset.textureHeight,n=t.shape.settings.size,c=new i.Vector2,d=new i.Vector2,a=new i.Vector2,l=new i.Vector2;o=t.shape.textureLayout.left.offset,c.set(o.x/s,(r-o.y-n.y)/r),d.set((o.x+n.z)/s,(r-o.y-n.y)/r),a.set(o.x/s,(r-o.y)/r),l.set((o.x+n.z)/s,(r-o.y)/r),e.faceVertexUvs[0][2][0].copy(a),e.faceVertexUvs[0][2][1].copy(c),e.faceVertexUvs[0][2][2].copy(l),e.faceVertexUvs[0][3][0].copy(c),e.faceVertexUvs[0][3][1].copy(d),e.faceVertexUvs[0][3][2].copy(l),o=t.shape.textureLayout.front.offset,c.set(o.x/s,(r-o.y-n.y)/r),d.set((o.x+n.x)/s,(r-o.y-n.y)/r),a.set(o.x/s,(r-o.y)/r),l.set((o.x+n.x)/s,(r-o.y)/r),e.faceVertexUvs[0][8][0].copy(a),e.faceVertexUvs[0][8][1].copy(c),e.faceVertexUvs[0][8][2].copy(l),e.faceVertexUvs[0][9][0].copy(c),e.faceVertexUvs[0][9][1].copy(d),e.faceVertexUvs[0][9][2].copy(l),o=t.shape.textureLayout.right.offset,c.set(o.x/s,(r-o.y-n.y)/r),d.set((o.x+n.z)/s,(r-o.y-n.y)/r),a.set(o.x/s,(r-o.y)/r),l.set((o.x+n.z)/s,(r-o.y)/r),e.faceVertexUvs[0][0][0].copy(a),e.faceVertexUvs[0][0][1].copy(c),e.faceVertexUvs[0][0][2].copy(l),e.faceVertexUvs[0][1][0].copy(c),e.faceVertexUvs[0][1][1].copy(d),e.faceVertexUvs[0][1][2].copy(l),o=t.shape.textureLayout.back.offset,c.set(o.x/s,(r-o.y-n.y)/r),d.set((o.x+n.x)/s,(r-o.y-n.y)/r),a.set(o.x/s,(r-o.y)/r),l.set((o.x+n.x)/s,(r-o.y)/r),e.faceVertexUvs[0][10][0].copy(a),e.faceVertexUvs[0][10][1].copy(c),e.faceVertexUvs[0][10][2].copy(l),e.faceVertexUvs[0][11][0].copy(c),e.faceVertexUvs[0][11][1].copy(d),e.faceVertexUvs[0][11][2].copy(l),o=t.shape.textureLayout.top.offset,c.set(o.x/s,(r-o.y-n.z)/r),d.set((o.x+n.x)/s,(r-o.y-n.z)/r),a.set(o.x/s,(r-o.y)/r),l.set((o.x+n.x)/s,(r-o.y)/r),e.faceVertexUvs[0][4][0].copy(a),e.faceVertexUvs[0][4][1].copy(c),e.faceVertexUvs[0][4][2].copy(l),e.faceVertexUvs[0][5][0].copy(c),e.faceVertexUvs[0][5][1].copy(d),e.faceVertexUvs[0][5][2].copy(l),o=t.shape.textureLayout.bottom.offset,c.set(o.x/s,(r-o.y-n.z)/r),d.set((o.x+n.x)/s,(r-o.y-n.z)/r),a.set(o.x/s,(r-o.y)/r),l.set((o.x+n.x)/s,(r-o.y)/r),e.faceVertexUvs[0][6][0].copy(a),e.faceVertexUvs[0][6][1].copy(c),e.faceVertexUvs[0][6][2].copy(l),e.faceVertexUvs[0][7][0].copy(c),e.faceVertexUvs[0][7][1].copy(d),e.faceVertexUvs[0][7][2].copy(l),e.uvsNeedUpdate=!0},t.prototype.setIsLayerActive=function(e){null!=this.threeRoot&&(this.threeRoot.visible=e)},t.Updater=r.default,t}(SupEngine.ActorComponent);Object.defineProperty(o,"__esModule",{value:!0}),o.default=n},{"./CubicModelRendererUpdater":2}],2:[function(e,t,o){var s=SupEngine.THREE,i=function(){function e(e,t,o,s,i){this.cubicModelAsset=null,this.cubicModelSubscriber={onAssetReceived:this._onCubicModelAssetReceived.bind(this),onAssetEdited:this._onCubicModelAssetEdited.bind(this),onAssetTrashed:this._onCubicModelAssetTrashed.bind(this)},this.client=e,this.cubicModelRenderer=t,this.receiveAssetCallbacks=s,this.editAssetCallbacks=i,this.cubicModelAssetId=o.cubicModelAssetId,null!=this.cubicModelAssetId&&this.client.subAsset(this.cubicModelAssetId,"cubicModel",this.cubicModelSubscriber)}return e.prototype.destroy=function(){null!=this.cubicModelAssetId&&this.client.unsubAsset(this.cubicModelAssetId,this.cubicModelSubscriber)},e.prototype._onCubicModelAssetReceived=function(e,t){this.cubicModelAsset=t,this._setCubicModel(),null!=this.receiveAssetCallbacks&&this.receiveAssetCallbacks.cubicModel()},e.prototype._setCubicModel=function(){return null==this.cubicModelAsset?void this.cubicModelRenderer.setCubicModel(null):void this.cubicModelRenderer.setCubicModel(this.cubicModelAsset.pub)},e.prototype._onCubicModelAssetEdited=function(e,t){for(var o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];var i=this["_onEditCommand_"+t];if(null!=i&&i.apply(this,o),null!=this.editAssetCallbacks){var r=this.editAssetCallbacks.cubicModel[t];null!=r&&r.apply(null,o)}},e.prototype._onEditCommand_setProperty=function(e,t){switch(e){case"pixelsPerUnit":var o=1/t;this.cubicModelRenderer.threeRoot.scale.set(o,o,o),this.cubicModelRenderer.threeRoot.updateMatrixWorld(!1)}},e.prototype._onEditCommand_addNode=function(e,t,o){this._createRendererNode(e)},e.prototype._createRendererNode=function(e){var t=this.cubicModelAsset.nodes.parentNodesById[e.id],o=null!=t?this.cubicModelRenderer.byNodeId[t.id]:null,s=null!=t?t.shape.offset:{x:0,y:0,z:0};this.cubicModelRenderer._makeNode(e,o,s)},e.prototype._onEditCommand_moveNode=function(e,t,o){var i=this.cubicModelRenderer.byNodeId[e],r=i.pivot,n=r.matrixWorld.clone(),c=r.parent.userData.cubicNodeId;if(null!=c){var d=this.cubicModelRenderer.byNodeId[c];d.children.splice(d.children.indexOf(i),1)}var a=null!=t?this.cubicModelRenderer.byNodeId[t].pivot:this.cubicModelRenderer.threeRoot;a.add(r),n.multiplyMatrices((new s.Matrix4).getInverse(a.matrixWorld),n),n.decompose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(!1)},e.prototype._onEditCommand_moveNodePivot=function(e,t){var o=this,s=this.cubicModelRenderer.byNodeId[e],i=this.cubicModelAsset.nodes.byId[e],r=this.cubicModelAsset.nodes.parentNodesById[e],n=null!=r?r.shape.offset:{x:0,y:0,z:0};s.pivot.position.set(t.x+n.x,t.y+n.y,t.z+n.z),s.pivot.quaternion.set(i.orientation.x,i.orientation.y,i.orientation.z,i.orientation.w),s.shape.position.set(i.shape.offset.x,i.shape.offset.y,i.shape.offset.z);for(var c=function e(t,s){var i=o.cubicModelAsset.nodes.byId[t.nodeId];t.pivot.position.set(i.position.x+s.x,i.position.y+s.y,i.position.z+s.z);for(var r=0,n=t.children;r<n.length;r++){var c=n[r];e(c,i.shape.offset)}},d=0,a=s.children;d<a.length;d++){var l=a[d];c(l,i.shape.offset)}s.pivot.updateMatrixWorld(!1)},e.prototype._onEditCommand_setNodeProperty=function(e,t,o){var i=this,r=this.cubicModelRenderer.byNodeId[e],n=this.cubicModelAsset.nodes.byId[e];switch(t){case"name":r.pivot.name=o;break;case"position":var c=this.cubicModelAsset.nodes.parentNodesById[e],d=null!=c?c.shape.offset:{x:0,y:0,z:0};r.pivot.position.set(o.x+d.x,o.y+d.y,o.z+d.z),r.pivot.updateMatrixWorld(!1);break;case"orientation":r.pivot.quaternion.set(o.x,o.y,o.z,o.w),r.pivot.updateMatrixWorld(!1);break;case"shape.offset":r.shape.position.set(o.x,o.y,o.z);for(var a=function e(t,o){var s=i.cubicModelAsset.nodes.byId[t.nodeId];t.pivot.position.set(s.position.x+o.x,s.position.y+o.y,s.position.z+o.z);for(var r=0,n=t.children;r<n.length;r++){var c=n[r];e(c,s.shape.offset)}},l=0,u=r.children;l<u.length;l++){var p=u[l];a(p,n.shape.offset)}r.pivot.updateMatrixWorld(!1);break;default:switch(n.shape.type){case"box":switch(t){case"shape.settings.size":var h=r.shape.geometry=new s.BoxGeometry(o.x,o.y,o.z);this.cubicModelRenderer.updateBoxNodeUv(h,n);break;case"shape.settings.stretch":r.shape.scale.set(o.x,o.y,o.z),r.shape.updateMatrixWorld(!1)}}}},e.prototype._onEditCommand_duplicateNode=function(e,t){for(var o=0,s=t;o<s.length;o++){var i=s[o];this._createRendererNode(i.node)}},e.prototype._onEditCommand_removeNode=function(e){this._recurseClearNode(e)},e.prototype._recurseClearNode=function(e){for(var t=this.cubicModelRenderer.byNodeId[e],o=0,s=t.children;o<s.length;o++){var i=s[o];this._recurseClearNode(i.nodeId)}var r=t.pivot.parent,n=r.userData.cubicNodeId;if(null!=n){var c=this.cubicModelRenderer.byNodeId[n];c.children.splice(c.children.indexOf(t),1)}t.shape.parent.remove(t.shape),t.shape.geometry.dispose(),t.shape.material.dispose(),t.pivot.parent.remove(t.pivot),delete this.cubicModelRenderer.byNodeId[e]},e.prototype._onEditCommand_moveNodeTextureOffset=function(e,t){for(var o=0,s=e;o<s.length;o++){var i=s[o],r=this.cubicModelAsset.nodes.byId[i],n=this.cubicModelRenderer.byNodeId[i].shape.geometry;this.cubicModelRenderer.updateBoxNodeUv(n,r)}},e.prototype._onEditCommand_changeTextureWidth=function(){this._onChangeTextureSize()},e.prototype._onEditCommand_changeTextureHeight=function(){this._onChangeTextureSize()},e.prototype._onChangeTextureSize=function(){for(var e in this.cubicModelAsset.nodes.byId){var t=this.cubicModelAsset.nodes.byId[e],o=this.cubicModelRenderer.byNodeId[e].shape;this.cubicModelRenderer.updateBoxNodeUv(o.geometry,t);var s=o.material;s.map=this.cubicModelAsset.pub.textures.map,s.needsUpdate=!0}},e.prototype._onCubicModelAssetTrashed=function(){this.cubicModelAsset=null,this.cubicModelRenderer.setCubicModel(null),null!=this.editAssetCallbacks&&SupClient.onAssetTrashed()},e.prototype.config_setProperty=function(e,t){switch(e){case"cubicModelAssetId":null!=this.cubicModelAssetId&&this.client.unsubAsset(this.cubicModelAssetId,this.cubicModelSubscriber),this.cubicModelAssetId=t,this.cubicModelAsset=null,this.cubicModelRenderer.setCubicModel(null,null),null!=this.cubicModelAssetId&&this.client.subAsset(this.cubicModelAssetId,"cubicModel",this.cubicModelSubscriber)}},e}();Object.defineProperty(o,"__esModule",{value:!0}),o.default=i},{}],3:[function(e,t,o){var s=e("./CubicModelRenderer");SupEngine.registerComponentClass("CubicModelRenderer",s.default)},{"./CubicModelRenderer":1}]},{},[3]);