"use strict";!function t(e,s,i){function n(o,h){if(!s[o]){if(!e[o]){var a="function"==typeof require&&require;if(!h&&a)return a(o,!0);if(r)return r(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var c=s[o]={exports:{}};e[o][0].call(c.exports,function(t){var s=e[o][1][t];return n(s?s:t)},c,c.exports,t,e,s,i)}return s[o].exports}for(var r="function"==typeof require&&require,o=0;o<i.length;o++)n(i[o]);return n}({1:[function(t,e,s){var i=this&&this.__extends||function(t,e){function s(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)},n=SupEngine.THREE,r=t("./TextRendererUpdater"),o=t("./TextRendererGeometry"),h=function(t){function e(e){t.call(this,e,"TextRenderer"),this.threeMeshes=[]}return i(e,t),e.prototype.setText=function(t){this.text=t,this._createMesh()},e.prototype.setFont=function(t){this.font=t,this._createMesh()},e.prototype.setOptions=function(t){null==t.alignment&&(t.alignment="center"),null==t.verticalAlignment&&(t.verticalAlignment="center"),this.options=t,this._createMesh()},e.prototype.setOpacity=function(t){this.opacity=t;for(var e=0,s=this.threeMeshes;e<s.length;e++){var i=s[e];null!=this.opacity?(i.material.transparent=!0,i.material.opacity=this.opacity):(i.material.transparent=!1,i.material.opacity=1),i.material.needsUpdate=!0}},e.prototype._createMesh=function(){if(this.clearMesh(),null!=this.text&&null!=this.font){this.font.isBitmap?null!=this.font.texture&&this._createBitmapMesh():this._createFontMesh();for(var t=0,e=this.threeMeshes;t<e.length;t++){var s=e[t];this.actor.threeObject.add(s);var i=1/this.font.pixelsPerUnit;s.scale.set(i,i,i),s.updateMatrixWorld(!1)}}},e.prototype._createFontMesh=function(){var t=null!=this.options.size?this.options.size:this.font.size,e=this.text.split("\n"),s=document.createElement("canvas"),i=s.getContext("2d");i.font=t+"px "+this.font.name;for(var r=1,o=0,h=e;o<h.length;o++){var a=h[o];r=Math.max(r,i.measureText(a).width)}var l=.3*t,c=t*e.length,p=c+2*l;s.width=r,s.height=p;var u=null!=this.options.color?this.options.color:this.font.color;i.fillStyle="#"+u,i.font=t+"px "+this.font.name,i.textBaseline="middle",i.textAlign=this.options.alignment;var f=r/2;switch(this.options.alignment){case"left":f=0;break;case"right":f=r}for(var d=0;d<e.length;d++)i.fillText(e[d],f,l+(.5+(d-(e.length-1)/2)/e.length)*c);this.texture=new n.Texture(s),"pixelated"===this.font.filtering?(this.texture.magFilter=SupEngine.THREE.NearestFilter,this.texture.minFilter=SupEngine.THREE.NearestFilter):this.texture.minFilter=SupEngine.THREE.LinearFilter,this.texture.needsUpdate=!0;var x=new n.PlaneBufferGeometry(r,p),g=new n.MeshBasicMaterial({map:this.texture,alphaTest:.01,side:n.DoubleSide});switch(this.threeMeshes[0]=new n.Mesh(x,g),this.setOpacity(this.opacity),this.options.alignment){case"left":this.threeMeshes[0].position.setX(r/2/this.font.pixelsPerUnit);break;case"right":this.threeMeshes[0].position.setX(-r/2/this.font.pixelsPerUnit)}switch(this.options.verticalAlignment){case"top":this.threeMeshes[0].position.setY(-p/2/this.font.pixelsPerUnit);break;case"bottom":this.threeMeshes[0].position.setY(p/2/this.font.pixelsPerUnit)}},e.prototype._createBitmapMesh=function(){for(var t=this.text.split("\n"),e=0;e<t.length;e++){var s=t[e],i=new o.default(this.font.gridWidth*s.length,this.font.gridHeight,s.length,1),r=new n.MeshBasicMaterial({map:this.font.texture,alphaTest:.1,side:n.DoubleSide}),h=null!=this.options.color?this.options.color:this.font.color;switch(r.color.setHex(parseInt(h,16)),this.threeMeshes[e]=new n.Mesh(i,r),this.options.alignment){case"center":this.threeMeshes[e].position.setX(-i.width/2/this.font.pixelsPerUnit);break;case"right":this.threeMeshes[e].position.setX(-i.width/this.font.pixelsPerUnit)}var a=void 0;switch(this.options.verticalAlignment){case"center":a=(.5+(e-(t.length-1)/2))*this.font.gridHeight/this.font.pixelsPerUnit;break;case"top":a=(1+e)*this.font.gridHeight/this.font.pixelsPerUnit;break;case"bottom":a=(e-t.length+1)*this.font.gridHeight/this.font.pixelsPerUnit}this.threeMeshes[e].position.setY(-a);var l=i.getAttribute("uv");l.needsUpdate=!0;for(var c=this.font.texture.image.width/this.font.gridWidth,p=0;p<s.length;p++){var u=void 0;u=null==this.font.charset?s.charCodeAt(p)-this.font.charsetOffset:this.font.charset.indexOf(s[p]);var f=u%c,d=Math.floor(u/c),x=(f*this.font.gridWidth+.2)/this.font.texture.image.width,g=((f+1)*this.font.gridWidth-.2)/this.font.texture.image.width,y=1-((d+1)*this.font.gridHeight-.2)/this.font.texture.image.height,v=1-(d*this.font.gridHeight+.2)/this.font.texture.image.height,b=l.array;b[8*p+0]=x,b[8*p+1]=y,b[8*p+2]=g,b[8*p+3]=y,b[8*p+4]=g,b[8*p+5]=v,b[8*p+6]=x,b[8*p+7]=v}}this.setOpacity(this.opacity)},e.prototype.clearMesh=function(){for(var t=0,e=this.threeMeshes;t<e.length;t++){var s=e[t];this.actor.threeObject.remove(s),s.geometry.dispose(),s.material.dispose()}this.threeMeshes.length=0,null!=this.texture&&(this.texture.dispose(),this.texture=null)},e.prototype._destroy=function(){this.clearMesh(),t.prototype._destroy.call(this)},e.prototype.setIsLayerActive=function(t){for(var e=0,s=this.threeMeshes;e<s.length;e++){var i=s[e];i.visible=t}},e.Updater=r.default,e}(SupEngine.ActorComponent);Object.defineProperty(s,"__esModule",{value:!0}),s.default=h},{"./TextRendererGeometry":2,"./TextRendererUpdater":3}],2:[function(t,e,s){var i=this&&this.__extends||function(t,e){function s(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)},n=SupEngine.THREE,r=function(t){function e(e,s,i,r){t.call(this),this.type="TextRendererGeometry",this.width=e,this.height=s;var o,h=new Float32Array(i*r*4*3),a=new Float32Array(i*r*4*3),l=new Float32Array(i*r*4*2);o=h.length/3>65535?new Uint32Array(i*r*6):new Uint16Array(i*r*6);for(var c=0,p=0,u=0,f=0;f<r;f++)for(var d=f*s/r,x=0;x<i;x++){var g=x*e/i;h[c+0]=g,h[c+1]=d,a[c+2]=1,l[p+0]=x/i,l[p+1]=f/r,h[c+3]=g+e/i,h[c+4]=d,a[c+5]=1,l[p+2]=(x+1)/i,l[p+3]=f/r,h[c+6]=g+e/i,h[c+7]=d+s/r,a[c+8]=1,l[p+4]=(x+1)/i,l[p+5]=(f+1)/r,h[c+9]=g,h[c+10]=d+s/r,a[c+11]=1,l[p+6]=x/i,l[p+7]=(f+1)/r;var y=4*(x+f*i);o[u+0]=y+0,o[u+1]=y+1,o[u+2]=y+2,o[u+3]=y+0,o[u+4]=y+3,o[u+5]=y+2,c+=12,p+=8,u+=6}this.setIndex(new n.BufferAttribute(o,1)),this.addAttribute("position",new n.BufferAttribute(h,3)),this.addAttribute("normal",new n.BufferAttribute(a,3)),this.addAttribute("uv",new n.BufferAttribute(l,2))}return i(e,t),e}(n.BufferGeometry);Object.defineProperty(s,"__esModule",{value:!0}),s.default=r},{}],3:[function(t,e,s){var i=function(){function t(t,e,s,i){var n=this;this.client=t,this.textRenderer=e,this.externalSubscriber=i,this.onFontAssetReceived=function(t,e){n.fontAsset=e,n.textRenderer.setText(n.text),n.textRenderer.setOptions(n.options),n.overrideOpacity||(n.textRenderer.opacity=e.pub.opacity),n.setupFont(),n.externalSubscriber.onAssetReceived&&n.externalSubscriber.onAssetReceived(t,e)},this.onFontAssetEdited=function(t,e){for(var s=[],i=2;i<arguments.length;i++)s[i-2]=arguments[i];var r=n.onEditCommands[e];null!=r&&r.apply(n,s),n.externalSubscriber.onAssetEdited&&(o=n.externalSubscriber).onAssetEdited.apply(o,[t,e].concat(s));var o},this.onEditCommands={upload:function(){n.setupFont()},setProperty:function(t,e){switch(t){case"isBitmap":n.setupFont();break;case"opacity":n.overrideOpacity||n.textRenderer.setOpacity(e);break;default:n.textRenderer.setFont(n.fontAsset.pub)}}},this.onFontAssetTrashed=function(t){n.textRenderer.clearMesh(),null!=n.externalSubscriber.onAssetTrashed&&n.externalSubscriber.onAssetTrashed(t)},this.fontAssetId=s.fontAssetId,this.text=s.text,this.options={alignment:s.alignment,verticalAlignment:s.verticalAlignment,size:s.size,color:s.color},this.overrideOpacity=s.overrideOpacity,this.opacity=s.opacity,this.overrideOpacity&&this.textRenderer.setOpacity(this.opacity),null==this.externalSubscriber&&(this.externalSubscriber={}),this.fontSubscriber={onAssetReceived:this.onFontAssetReceived,onAssetEdited:this.onFontAssetEdited,onAssetTrashed:this.onFontAssetTrashed},null!=this.fontAssetId&&this.client.subAsset(this.fontAssetId,"font",this.fontSubscriber)}return t.prototype.destroy=function(){null!=this.fontAssetId&&this.client.unsubAsset(this.fontAssetId,this.fontSubscriber)},t.prototype.config_setProperty=function(t,e){switch(t){case"fontAssetId":null!=this.fontAssetId&&this.client.unsubAsset(this.fontAssetId,this.fontSubscriber),this.fontAssetId=e,this.fontAsset=null,this.textRenderer.setFont(null),null!=this.fontAssetId&&this.client.subAsset(this.fontAssetId,"font",this.fontSubscriber);break;case"text":this.text=e,this.textRenderer.setText(this.text);break;case"alignment":case"verticalAlignment":case"size":case"color":this.options[t]=""!==e?e:null,this.textRenderer.setOptions(this.options);break;case"overrideOpacity":case"opacity":this[t]=e,this.overrideOpacity?this.textRenderer.setOpacity(this.opacity):null!=this.fontAsset&&this.textRenderer.setOpacity(this.fontAsset.pub.opacity)}},t.prototype.setupFont=function(){var t=this;if(this.textRenderer.clearMesh(),this.fontAsset.pub.isBitmap){if(null!=this.fontAsset.pub.texture){var e=this.fontAsset.pub.texture.image;e.complete?this.textRenderer.setFont(this.fontAsset.pub):e.addEventListener("load",function(){t.textRenderer.setFont(t.fontAsset.pub)})}}else null==this.fontAsset.font?this.textRenderer.setFont(this.fontAsset.pub):this.fontAsset.font.load().then(function(){t.textRenderer.setFont(t.fontAsset.pub)},function(){t.textRenderer.setFont(t.fontAsset.pub)})},t}();Object.defineProperty(s,"__esModule",{value:!0}),s.default=i},{}],4:[function(t,e,s){var i=t("./TextRenderer");SupEngine.registerComponentClass("TextRenderer",i.default)},{"./TextRenderer":1}]},{},[4]);